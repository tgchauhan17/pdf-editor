$(function(){function t(){var t=$("#image-editable-menu");t.hide()}function e(){var t=$("#shape-editable-menu");t.hide()}function a(t){var e=$("#shape-editable-menu");e.css({position:"absolute","z-index":"1000",top:t.offset().top-60,left:t.offset().left}).attr("data-target-id",t.attr("id")).show()}function i(t,i,n,o,r,s,d,l){s.find(".page");o=o||200,r=r||100;var c=$('<div class="shape-editable"></div>'),f=parseFloat(s.attr("data-scale"));c.css({"border-width":f*window.lastShapeEditSettings["border-width"]+"px","border-color":d||window.lastShapeEditSettings["border-color"],"background-color":l||window.lastShapeEditSettings["background-color"],"border-style":"solid",width:o+"px",height:r+"px"}),"ellipse"==t&&c.css({"border-radius":"50%"}),c.attr("id","shape-editable-"+ut++),c.css({position:"absolute",top:i+"px",left:n+"px"}),s.append(c),c.draggable().resizable({handles:"all"}),c.addClass("active").addClass("shape-"+t),setTimeout(function(){a(c)},100),c.click(function(t){var e=$(this);a(e),c.find(".ui-resizable-handle").show(),c.addClass("active")}),c.on("resizestart",function(){e()}),c.on("resizestop",function(){setTimeout(function(){a(c)},100)}),c.on("dragstart",function(){e()}),c.on("dragstop",function(){setTimeout(function(){a(c)},100)}),c.on("mouseover",function(){c.find(".ui-resizable-handle").show()}),c.on("mouseout",function(){var t=$("#shape-editable-menu");c.hasClass("active")||t.is(":visible")&&t.attr("data-target-id")==c.attr("id")||c.find(".ui-resizable-handle").hide()})}function n(t){return $("#"+t.parents(".text-editable-menu").attr("data-target-id"))}function o(t,e,a){var i={};i[e]=a,n(t).css(i).focus()}function r(t,e,a,i){var r=n(t).css(e);return r==i?(o(t,e,a),a):(o(t,e,i),i)}function s(t){return $("#"+t.parents(".shape-editable-menu").attr("data-target-id"))}function d(t,e,a){var i={};i[e]=a,s(t).css(i).focus()}function l(t,e){return(t+e+360)%360}function c(t,e){var a=document.getElementById("image-rotation-canvas"),i=a.getContext("2d"),n=new Image;n.src=t.attr("src"),n.onload=function(){a.height=n.width,a.width=n.height,i.clearRect(0,0,a.width,a.height),i.save(),i.translate(a.width/2,a.height/2),i.rotate(90*Math.PI/180),i.drawImage(n,-a.height/2,-a.width/2),i.restore(),t.attr("src",a.toDataURL()),e()}}function f(){$("#link-editable-menu").hide()}function u(t){var e=$("#link-editable-menu");e.find("input").val(t.attr("data-uri")||""),e.css({position:"absolute","z-index":"1000",top:t.offset().top-60,left:t.offset().left}).attr("data-target-id",t.attr("id")).show()}function p(t,a,i,n,o){o.find(".page");i=i||200,n=n||100;var r=$('<div class="link-editable"></div>');parseFloat(o.attr("data-scale"));r.css({width:i+"px",height:n+"px"}),r.attr("id","link-editable-"+mt++),r.css({position:"absolute",top:t+"px",left:a+"px"}),o.append(r),r.draggable().resizable({handles:"all"}),r.addClass("active").addClass("shape-rectangle"),setTimeout(function(){u(r)},100),r.click(function(t){var e=$(this);u(e),r.find(".ui-resizable-handle").show(),r.addClass("active")}),r.on("resizestart",function(){e()}),r.on("resizestop",function(){setTimeout(function(){u(r)},100)}),r.on("dragstart",function(){f()}),r.on("dragstop",function(){setTimeout(function(){f(r)},100)}),r.on("mouseover",function(){r.find(".ui-resizable-handle").show()}),r.on("mouseout",function(){var t=$("#link-editable-menu");r.hasClass("active")||t.is(":visible")&&t.attr("data-target-id")==r.attr("id")||r.find(".ui-resizable-handle").hide()})}function g(t,e,a){var i=$('<div class="page-container"></div>'),n=$('<div class="page-tools-menu"><div class="btn-group btn-group-vertical" role="group" aria-label="Page Tools"><button type="button" class="btn btn-default btn-xs" title="Delete PDF Page" data-tool="delete-page" style=""><i class="fa fa-trash-o"></i></button></div></div>'),o=$('<div class="page-wrap"><canvas class="page"></canvas></div>');o.attr("data-page-num",e),o.attr("data-original-page-num",e),i.append(n).append('<div class="page-number-label"></div>').append(o),i.find(".page-number-label").text(e),bt.append(i);var r=F(),s=700;o.find("canvas").attr("height",s).attr("width",r),a()}function h(){$(".page-wrap").not(".rendered").each(function(){if($(this).isInViewport()){var t=$(this),e=parseInt(t.attr("data-original-page-num"));vt?z(vt,e,function(){}):console.log("Cant render",e,"nothing found in cache")}})}function m(t){return{top:Math.floor(t.top),left:Math.floor(t.left),bottom:Math.floor(t.bottom),right:Math.floor(t.right)}}function v(t){var e=m(t.get(0).getBoundingClientRect()),a=t.parent(".textLayer");a.find("div").not(t).each(function(){var t=$(this),a=m(this.getBoundingClientRect()),i=e.right>=a.right&&e.left<=a.left&&e.bottom>=a.bottom&&e.top<=a.top;i&&($("#"+t.attr("data-inline-editor-id")).remove(),t.remove())})}function w(t,e,a){return a=a||2,Math.abs(t-e)<=a}function b(t){if(!$t[t]){var e=$('<span style="font-family: '+t+';">&nbsp;</span>');$("body").append(e);var a=e.width();e.remove(),$t[t]=a}return $t[t]}function x(t){var e=t.css("transform");if("none"==e)return 1;var a=e.substring(7,e.length-1).split(", ");return parseFloat(a[0])}function y(t){var e=t.find("div").map(function(t,e){var a=$(e),i=a.position(),n=a.height(),o=x(a),r=a.width()*o,s=a.text().trim();return n>2*r&&s.length>1||void 0!=a.attr("data-angle")?(a.addClass("not-editable"),null):(a.css({width:r,"overflow-x":"hidden",transform:"none"}),new k({top:i.top,bottom:i.top+n,left:i.left,right:i.left+r,height:n,width:r,scaleX:o,text:a.text(),fontFace:a.attr("data-font-face"),node:a}))}).toArray();e.sort(function(t,e){var a=w(t.top,e.top,4);return a?t.left-e.left:t.top-e.top});var a;e.forEach(function(t,e,i){if(null!=t)if(a){var n=w(a.top,t.top,1),o=w(a.right,t.left,a.height);if(n&&o){a.right+b(a.fontFace)<t.left&&a.node.append(" "),a.node.append(t.node.html()),t.node.remove();var r=$(a.node);a.node=r,a.width=t.right-a.left,a.height=Math.max(t.height,a.height),a.right=t.right,a.node.css({width:a.width})}else a=t}else a=t})}function k(t){return _.extend(this,t),this}function C(t){y(t)}function S(t,e){var a=$('<div class="font-compare" style="font-family: \'Times New Roman\', serif;"></div>'),i=$('<div class="font-compare" style="font-family: '+e+", 'Times New Roman', serif;\"></div>"),n=$("body");n.append(a),n.append(i);for(var o=0,r=t.length;o<r;o++){var s=t[o];a.text(s),i.text(s);var d=a.width(),l=i.width(),c=a.height(),f=i.height();if(d==l&&c==f&&0!=d&&0!=a)return console.log("Missing glyph",s,"in font",e,"w1",d,"w2",l),a.remove(),i.remove(),!0}return a.remove(),i.remove(),!1}function E(){var t=$(".font-family-opts"),e=_.keys(document.PDFJSFonts);e.length>0&&(0==t.find("li.divider").length&&t.append('<li role="separator" class="divider"></li>'),_.each(e,function(e){if(!(t.find('[data-font="'+e+'"]').length>0)){var a=document.PDFJSFonts[e],i=a;"+"==a.charAt(6)&&(i=i.substring(7)),i=i.replace(/-/g," "),t.append('<li><a data-font="'+e+'" class="doc-font" href="javascript://">'+i+' <span class="input-help"><i class="fa fa-question-circle" data-toggle="tooltip" data-placement="top" data-html="true" title="This is a document embedded font. Characters may be missing."></i></span></a></li>')}}),$('.font-family-opts .input-help [data-toggle="tooltip"]').tooltip())}function T(t){t.find("div").map(function(t,e){var a=$(e),i=a.attr("data-font-face");a.css({"font-family":i})})}function F(){return Math.min(1600,Math.max(800,$(window).width()-100))}function A(t){yt||(yt=!0,$(".page-wrap").not(".rendered").each(function(){$(this).find("canvas").attr("height",t)}))}function z(t,e,a){t.getPage(e).then(function(t){var i=F(),n=t.getViewport(1),o=i/n.width,r=t.getViewport(o),s=$(".page-wrap[data-original-page-num="+e+"]");s.attr("data-scale",o),s.addClass("rendered");var d=s.find("canvas").get(0),l=d.getContext("2d");d.height=r.height,d.width=r.width;var c={canvasContext:l,viewport:r};l.clearRect(0,0,d.width,d.height);var f=$('<div class="textLayer"></div>');f.css({height:r.height+"px",width:r.width+"px"}),s.append(f);var u=$('<div class="formLayer"></div>');if(u.css({height:r.height+"px",width:r.width+"px"}),s.append(u),1==e){var p=s.parents(".page-container"),g=p.clone();g.removeClass("page-container").attr("id","new-page-template").css({display:"none"}),g.insertBefore(p)}var h=t.render(c);return h.promise.then(function(){$(document).trigger("pdfPageContentRendered",{pageNum:e}),t.getTextContent({normalizeWhitespace:!0}).then(function(e){var a=PDFJS.renderTextLayer({textContent:e,container:f.get(0),viewport:r,textDivs:[],enhanceTextSelection:!0});a.promise.then(function(){f.find(".endOfContent").remove(),C(f),T(f),E(),PDFJS.FormFunctionality.setPostRenderHook(function(t){var e=PDFJS.FormFunctionality.getFormValues();e&&Object.keys(e).length>0&&J("form");var a=$(".formLayer");a.find("textarea").each(function(){var t=$(this),e=Y(t.css("font-size"));e>20&&t.css({"font-size":"20px"})}),a.find("input[type=text]").each(function(){var t=$(this),e=Y(t.css("font-size"));if(e>18){var a=.75*e;t.css({"font-size":a+"px"})}})}),PDFJS.FormFunctionality.renderForm(u.get(0),t,r,{}),A(d.height),t.cleanup()})}),a(null)},function(t){a(t)})})}function B(t){t.getMetadata().then(function(t){t&&t.info&&t.info.Creator&&t.info.Creator.indexOf("Canon")>=0&&showAlert("Editing a scanned PDF? Warning: support for this type of documents is limited.","warning")}).catch(function(t){console.log(t)})}function I(){var t='<div class="page-between"><a href="javascript://" class="btn btn-light btn-xs">Insert page here</a></div>';$(".page-container").each(function(){$(this).prepend(t)});var e=$('<div class="page-container last"></div>');e.append(t),$("#edit-pages").append(e)}function D(t){function e(t){$(".doc-loading").hide(),$(".page-loading").show(),vt=t;for(var e=1;e<=t.numPages;e++)g(t,e,function(){});wt.show(),wt.scrollHere(),h(),B(t),I()}function a(){$(".doc-loading").hide(),$(".task-form").find("[type=submit]").attr("disabled","disabled")}PdfFiles.getDocument(t,e,a)}function O(){Ct.find("[data-tool]").removeClass("active"),bt.attr("data-tool","none")}function P(t){return bt.attr("data-tool")==t}function R(){return void 0!=_.find(arguments,function(t){return bt.attr("data-tool")==t})}function L(t){M(t,15)}function M(t,e){t&&(e=e||5,St.html(t).fadeIn(500),kt=setTimeout(function(){St.hide()},1e3*e))}function N(t,e){var a=Ct.find("[data-tool="+t+"]");O(),bt.attr("data-tool",t),a.addClass("active"),e!==!0&&Et[t]&&M(Et[t])}function J(t){P(t)?O():N(t)}function U(){J("text")}function W(){document.selection?document.selection.empty():window.getSelection&&window.getSelection().removeAllRanges()}function j(){var t=1;$(".page-container").each(function(){var e=$(this),a=e.find(".page-wrap");a.attr("data-page-num",t),e.find(".page-number-label").text(t),t++})}function H(t){var e=$("#new-page-template").clone();e.addClass("page-container").css({display:""}).removeAttr("id");var a=e.find(".page-wrap"),i=a.find("canvas").get(0),n=i.getContext("2d");if(n.fillStyle="#FFFFFF",n.fillRect(0,0,i.width,i.height),a.find(".textLayer").remove(),a.find(".shape-editable").remove(),a.find(".image-editable").remove(),a.find(".text-editable").remove(),t.length>0)e.insertBefore(t);else{var o=$("#edit-pages");o.prepend(e)}a.attr("data-new-page","true"),a.removeAttr("data-original-page-num"),a.addClass("rendered"),j(),a.fadeOut(10,function(){a.fadeIn(400)}),a.scrollHere(100)}function V(t,e){var a=$("#text-editable-menu"),i=t.offset().left,n=a.width(),o=e.offset().left+e.width();if(i+n>o){var r=i+n-o;i=i-r-5}var s=parseFloat(e.attr("data-scale")),d=Y(t.css("font-size"))/s;a.find("input[name=fontSize]").val(d),a.css({position:"absolute","z-index":"1000",top:t.offset().top+t.height()+15,left:i}).attr("data-target-id",t.attr("id")).show()}function X(t,e){return t.hasClass(e)||t.parents("."+e).length>0}function Y(t){return t.slice(0,-2)}function Q(t){var e=t.toString(16);return 1==e.length?"0"+e:e}function q(t){return"#"+Q(t[0])+Q(t[1])+Q(t[2])}function G(t){if("rgba(0, 0, 0, 0)"!=t.trim()&&"transparent"!=t.trim()){if(0==t.trim().indexOf("#"))return t;if(0==t.trim().indexOf("rgb(")){var e=t.slice(4,-1).split(",");return e=_.map(e,function(t){return t.indexOf(".")>=0?Math.round(255*parseFloat(t.trim())):parseInt(t.trim())}),q(e)}return"#000000"}}function K(t){return Math.ceil(t.toFixed(2))}function Z(t){var e=$("#removeUnusedTextPrompt");e.find(".btn-yes").off("click").on("click",function(){t("yes"),e.modal("hide")}),e.find(".btn-no").off("click").on("click",function(){t("no"),e.modal("hide")}),e.modal("show")}function tt(t,e){return function(){try{e.apply(this)}catch(e){console.log("Exception occurred",t,e),Raven.captureException(e)}}}function et(){var t={};Bt.forEach(function(e){t[e]=[]});var e=($(".task-form"),$("#edit-pages"));e.find(".text-editable").each(tt(".text-editable",function(){var e=$(this);if(!e.hasClass("existingTextEdit")){var a=e.parents(".page-wrap"),i=a.find("canvas.page"),n=Big(a.attr("data-scale")),o=a.attr("data-page-num"),r=e.css("font-family").split(",")[0].trim().toLowerCase(),s="times_roman";r.indexOf("helvetica")>=0&&(s="helvetica"),r.indexOf("Courier New")>=0&&(s="courier"),document.PDFJSFonts[r]&&(s=document.PDFJSFonts[r]);var d=Y(e.css("font-size")),l=Big(d).div(n),c=e.height(),f=Big(c).minus(l).div(2),u={text:cleanUnicodeControlCharsAndSpaces(e.text()),font:s,fontSize:l,position:{x:Big(Y(e.css("left"))).div(n),y:Big(i.attr("height")).minus(Big(Y(e.css("top")))).minus(c).plus(f).div(n)},color:G(e.css("color")),bold:"bold"==e.css("font-weight"),italic:"italic"==e.css("font-style"),pages:o};""!=u.text.trim()&&t.appendTextOperations.push(JSON.stringify(u))}})),e.find(".textLayer .edited").each(tt(".textLayer .edited",function(){var e=$(this),a=$("#"+e.attr("data-inline-editor-id")),i=e.parents(".page-wrap"),n=i.find("canvas.page"),o=i.attr("data-scale"),r=i.attr("data-page-num"),s=e.outerHeight(),d=.5;s<=15&&(d=.7),s>=40&&(d=.3);var l=s*d,c=6,f=a.text()||"",u=a.attr("data-original-font-face"),p=a.css("font-family").split(",")[0].trim().toLowerCase(),g=void 0;u!=p&&(p.indexOf("helvetica")>=0&&(g="helvetica"),p.indexOf("courier new")>=0&&(g="courier"),document.PDFJSFonts[p]&&(g=document.PDFJSFonts[p]));var h=Y(a.css("font-size")),m=Big(h).div(o),v=a.height(),w=Big(v).minus(m).div(2),b={originalText:e.text(),text:cleanUnicodeControlCharsAndSpaces(f),font:g,bold:"bold"==a.css("font-weight"),italic:"italic"==a.css("font-style"),area:{x:K(new Big(Y(e.css("left"))-c).div(o)),y:K(new Big(Y(e.css("top"))-l).div(o)),width:K(new Big(parseInt(e.outerWidth())+2*c).div(o)),height:K(new Big(s+2*l).div(o))},pages:r,fontSize:m,color:G(a.css("color")),position:{x:Big(Y(a.css("left"))).div(o),y:Big(n.attr("height")).minus(Big(Y(a.css("top")))).minus(v).plus(w).div(o)}};t.editTextOperations.push(JSON.stringify(b))})),e.find(".image-editable").each(tt(".image-editable",function(){var e=$(this),a=e.parents(".page-wrap");if(a.hasClass("rendered")){var i=a.find("canvas.page"),n=Big(a.attr("data-scale")),o=a.attr("data-page-num"),r=6,s=Big(e.width()).div(n).times(2).toFixed(),d=Big(e.height()).div(n).times(2).toFixed(),l=e.attr("data-file-id");l||(l=resizeImage(e,s,d));var c=e.attr("data-rotation")||0,f={position:{x:Big(e.offset().left).minus(a.offset().left).plus(r).div(n),y:Big(i.attr("height")).minus(e.offset().top-a.offset().top).minus(e.outerHeight()).plus(r).div(n)},pages:o,width:Big(e.width()).div(n),height:Big(e.height()).div(n),rotation:c,image:l};"data:,"==l||l.endsWith(";base64,")||t.imageOperations.push(JSON.stringify(f))}})),e.find(".shape-editable").each(tt(".shape-editable",function(){try{var e=$(this),a=e.parents(".page-wrap");if(!a.hasClass("rendered"))return;var i=a.find("canvas.page"),n=a.attr("data-scale"),o=a.attr("data-page-num"),r=e,s=r.css("border-radius")||r.css("border-top-left-radius")||r.css("-ms-border-top-left-radius"),d=""!=s&&"0px"!=s?"ellipse":"rectangle",l=Y(r.css("border-top-width")),c={x:Big(e.offset().left).minus(a.offset().left).plus(l/2).div(n),y:Big(i.attr("height")).minus(e.offset().top-a.offset().top).minus(1.5*l).minus(e.height()).div(n)},f=Big(r.width()).plus(l).div(n),u=Big(r.height()).plus(l).div(n),p={position:c,pages:o,width:f,height:u,borderWidth:Big(l).div(n),borderColor:G(r.css("border-top-color")),backgroundColor:G(r.css("background-color")),shape:d};t.shapeOperations.push(JSON.stringify(p))}catch(t){Raven.captureException(t)}})),e.find(".link-editable").each(tt(".link-editable",function(){var e=$(this),a=e.parents(".page-wrap"),i=a.find("canvas.page"),n=parseFloat(a.attr("data-scale")),o=a.attr("data-page-num"),r=e,s=this.getBoundingClientRect(),d=$(this),l=d.offset(),c=a.offset(),f=[],u={left:parseInt(new Big(l.left-c.left).div(n).round()),top:parseInt(new Big(parseInt(i.attr("height"))-(l.top-c.top)).div(n).round()),bottom:parseInt(new Big(parseInt(i.attr("height"))-(l.top-c.top)-s.height).div(n).round()),right:parseInt(new Big(l.left-c.left+s.width).div(n).round())};u.left>=0&&u.top>=0&&u.right>=0&&u.bottom>=0&&u.top>u.bottom&&u.left<u.right?f.push(u):console.log("Ignoring invalid link bounding box",u);var p={boundingBoxes:f,page:o,uri:r.attr("data-uri")};p.boundingBoxes.length>0&&p.uri&&t.linkOperations.push(JSON.stringify(p))})),$(".page-wrap[data-new-page=true]").each(function(){var e=$(this),a=e.attr("data-page-num");t.insertPageOperations.push(JSON.stringify({page:a}))}),$(".page-container").each(function(){var e=$(this),a=e.find(".page-wrap");if(a.hasClass("rendered")){var i=a.attr("data-page-num"),n=a.find("canvas.page"),o=Big(a.attr("data-scale")),r=[];e.find(".textLayer").find(".highlighted").each(function(){var t=this.getBoundingClientRect(),e=$(this),i=e.offset(),s=a.offset(),d={left:parseInt(new Big(i.left-s.left).div(o).round()),top:parseInt(new Big(parseInt(n.attr("height"))-(i.top-s.top)).div(o).round()),bottom:parseInt(new Big(parseInt(n.attr("height"))-(i.top-s.top)-t.height).div(o).round()),right:parseInt(new Big(i.left-s.left+t.width).div(o).round())};d.left>=0&&d.top>=0&&d.right>=0&&d.bottom>=0&&d.top>d.bottom&&d.left<d.right?r.push(d):console.log("Ignoring invalid highlight box",d)}),r.length>0&&t.highlightTextOperations.push(JSON.stringify({page:i,boundingBoxes:r}))}}),$(".page-container").each(function(){var e=$(this),a=e.find(".page-wrap");if(a.hasClass("rendered")){var i=a.attr("data-page-num"),n=a.find("canvas.page"),o=Big(a.attr("data-scale")),r=[];e.find(".textLayer").find(".strikethrough").each(function(){var t=this.getBoundingClientRect(),e=$(this),i=e.offset(),s=a.offset(),d={left:parseInt(new Big(i.left-s.left).div(o).round()),top:parseInt(new Big(parseInt(n.attr("height"))-(i.top-s.top)).div(o).round()),bottom:parseInt(new Big(parseInt(n.attr("height"))-(i.top-s.top)-t.height).div(o).round()),right:parseInt(new Big(i.left-s.left+t.width).div(o).round())};d.left>=0&&d.top>=0&&d.right>=0&&d.bottom>=0&&d.top>d.bottom&&d.left<d.right?r.push(d):console.log("Ignoring invalid highlight box",d)}),r.length>0&&t.strikethroughTextOperations.push(JSON.stringify({page:i,boundingBoxes:r}))}});var a={},i=PDFJS.FormFunctionality.getFormValues(function(t){return"true"==$(t).attr("data-changed")});return Object.keys(i).forEach(function(t){var e=i[t];if("undefined"!=typeof e){var n=e+"";if(e instanceof Array)n=e.join(", ");else if("object"==typeof e){var o=[];Object.keys(e).forEach(function(t){o.push(e[t])}),n=o.join(", ")}a[t]=cleanUnicodeControlCharsAndSpaces(n)}}),Object.keys(a).length>0&&t.formValues.push(JSON.stringify(a)),t}function at(t){var e=$(".task-form");Bt.forEach(function(a){e.find('[name="'+a+'[]"]').remove(),t[a].forEach(function(t){e.append($('<input type="hidden" name="'+a+'[]">').val(t))})});var a=Date.now()-zt;e.find('[name="elapsedTime"]').val(Math.floor(a/1e3)),e.submit()}function it(){var t=Dt.val();It.text(t)}function nt(t){Analytics.trackEvent("pdf-editor-usage","signature-tool","generate"),rt(t),Rt.modal("hide"),setTimeout(function(){$("ul.sign-opts").find("img").first().click()},100),window.localStorage.setItem("signatureFont",t)}function ot(t){var e,a,i,n=t.getContext("2d"),o=document.createElement("canvas").getContext("2d"),r=n.getImageData(0,0,t.width,t.height),s=r.data.length,d={top:null,left:null,right:null,bottom:null};for(e=0;e<s;e+=4)0!==r.data[e+3]&&(a=e/4%t.width,i=~~(e/4/t.width),null===d.top&&(d.top=i),null===d.left?d.left=a:a<d.left&&(d.left=a),null===d.right?d.right=a:d.right<a&&(d.right=a),null===d.bottom?d.bottom=i:d.bottom<i&&(d.bottom=i));var l=d.bottom-d.top,c=d.right-d.left;try{var f=n.getImageData(d.left,d.top,c,l);o.canvas.width=c,o.canvas.height=l,o.putImageData(f,0,0)}catch(t){console.error(t)}return o.canvas}function rt(t){var e=Dt.val();It.each(function(){var a=$(this),i=a.css("font-family");if(t==i){var n=$('<li><a href="javascript://"><img src=""></a></li>'),o=document.createElement("canvas"),r=2;o.width=400*r,o.height=200*r;var s=o.getContext("2d");s.textBaseline="middle",s.font=Y(a.css("font-size"))*r+"px "+a.css("font-family"),s.fillStyle="black",s.strokeStyle="black",s.fillText(e,10,o.height/2);var d=ot(o).toDataURL();"data:,"!=d&&(n.find("img").attr("src",d),$("ul.sign-opts").prepend(n),$("ul.sign-opts").find("li.default").remove())}})}function st(){Analytics.trackEvent("pdf-editor-usage","signature-tool","draw");var t=ot(Ot).toDataURL();if("data:,"!=t){var e=$('<li><a href="javascript://"><img src=""></a></li>');e.find("img").attr("src",t),$("ul.sign-opts").prepend(e),$("ul.sign-opts").find("li.default").remove()}Rt.modal("hide"),setTimeout(function(){e.find("img").click()},200)}function dt(t,e){function a(){for(var t=0,n=0;n<i.length;n++){var o=i[n];o&&o.offsetWidth!=o.originalWidth&&(t+=1)}t>=i.length?setTimeout(e,1e3):setTimeout(a,1e3)}for(var i=[],n=0;n<t.length;n++){var o=t[n],r=document.createElement("span");r.innerHTML="giItT1WQy@!-/#",r.style.position="absolute",r.style.left="-10000px",r.style.top="-10000px",r.style.fontSize="300px",r.style.fontFamily="sans-serif",r.style.fontVariant="normal",r.style.fontStyle="normal",r.style.fontWeight="normal",r.style.letterSpacing="0",document.body.appendChild(r),r.originalWidth=r.offsetWidth,r.style.fontFamily=o,i.push(r)}a()}window.currentPage=function t(){var e=Math.max(document.documentElement.clientHeight,window.innerHeight||0),a=$(window).scrollTop(),t=_.find($(".page-wrap").get(),function(t){var i=$(t).offset().top,n=($(t).attr("data-page-num"),i>a&&i<e+a);return n});if(void 0==t&&(t=_.find($(".page-wrap").get(),function(t){var i=$(t).offset().top,n=i+$(t).height(),o=($(t).attr("data-page-num"),i<a&&n>e+a);return o})),void 0==t)return $(".page-wrap").last();var i=$(t);if(i.offset().top>a+e/2){var n=i.parents(".page-container").prev(".page-container").find(".page-wrap");n.length>0&&(i=n)}return i};var lt,ct;$(document).on("mousemove",function(t){lt=t.pageX,ct=t.pageY,$(".mouse-target").each(function(){$(this).css({left:lt-10,top:ct-10})})});var ft=0;$(document).on("click",".tools-menu .image-opts a img, .tools-menu .sign-opts a img, .non-interactive-forms-opts a img",function(){var t=$(this);N(t.parents(".image-opts").length>0?"image":t.parents(".non-interactive-forms-opts").length>0?"form":"sign");var e=$(this).clone().addClass("mouse-target image-editable-mouse-target").css({left:lt,top:ct});$("body").append(e)}),$(document).keyup(function(t){27==t.keyCode&&$(".mouse-target").remove()}),$(document).on("click","img.image-editable-mouse-target",function(e){function a(){function e(){o.css("height","")}o.resizable({aspectRatio:!0,handles:"all",autoHide:!0,stop:e}).parent(".ui-wrapper").draggable(),o.parent(".ui-wrapper").css({overflow:"",width:"",height:""}),o.find(".ui-resize-handler").hide(),o.click(function(t){var e=$(this),a=$("#image-editable-menu");a.css({position:"absolute","z-index":"1000",top:e.offset().top-70,left:e.offset().left-5}).attr("data-target-id",e.attr("id")).show(),o.find(".ui-resize-handler").show()}),o.on("resizestart",function(){t()}),o.on("dragstart",function(){t()});var a=o.parent(".ui-wrapper");a.on("resizestop",function(){a.css({width:"",height:""}),o.width()<70?a.addClass("small-image"):a.removeClass("small-image")}),o.on("mouseover",function(){o.find(".ui-resize-handler").show()}),o.on("mouseout",function(){var t=$("#image-editable-menu");t.is(":visible")&&t.attr("data-target-id")==o.attr("id")||o.find(".ui-resizable-handle").hide()}),i.remove(),o.css("height",""),o.css("width",n+10+"px"),n<70&&a.addClass("small-image")}var i=$(this),n=i.width();P("sign")?Analytics.trackEvent("pdf-editor-usage","sign-tool","insert"):Analytics.trackEvent("pdf-editor-usage","image-tool","insert");var o=i.clone().addClass("image-editable").removeClass("image-editable-mouse-target mouse-target"),r=currentPage(),s=r.find(".page");o.attr("id","image-editable-"+ft++);var d=e.pageY-s.offset().top-15,l=e.pageX-s.offset().left-15;o.css({position:"absolute",top:d+"px",left:l+"px"}),r.append(o),setTimeout(function(){var t=o.width(),e=o.height();if(r.height()<e||r.width()<t){var i=r.width()/t*.66,n=t*i,s=e*i,d=resizeImage(o,n,s);o.on("load",a),o.attr("src",d),o.width(n).height(s)}else a()},50)}),function(){function t(){var t=Math.min(a,o),e=Math.max(a,o),i=Math.min(n,r),d=Math.max(n,r);s.css({left:t+"px",top:i-15+"px",width:e-t+"px",height:d-i+"px"})}var e,a=0,n=0,o=0,r=0,s=$("#selectionBorder"),d=!1;$(document).on("mousedown",".page-wrap",function(i){if(R("whiteout","link","shape")){var l=$(i.target);if(X(l,"image-editable")||X(l,"text-editable")||X(l,"shape-editable")||X(l,"link-editable"))return;i.preventDefault(),d=!0,e=$(this),s.show(),a=i.pageX,n=i.pageY,o=a,r=n,t()}}),$(document).on("mousemove",function(e){R("whiteout","link","shape")&&d&&(o=e.pageX,r=e.pageY,t())}),$(document).on("mouseup",function(t){if(R("whiteout","link","shape")&&d){var l=Math.min(a,o),c=Math.max(a,o),f=Math.min(n,r),u=Math.max(n,r),g=e.find(".page"),h=l-g.offset().left,m=f-g.offset().top,v=c-l,w=u-f;if(v<5||w<5)return;try{P("whiteout")?i("rectangle",m,h,v,w,e,"transparent","#FFFFFF"):P("link")?p(m,h,v,w,e):P("shape")&&i(pt||"rectangle",m,h,v,w,e)}catch(t){console.log(t)}s.hide(),d=!1,R("shape")||O()}}),$(document).keyup(function(t){27==t.keyCode&&(s.hide(),O())})}();var ut=0,pt="";$(document).on("click",".tools-menu .shape-opts a",function(){pt=$(this).attr("data-shape"),Analytics.trackEvent("pdf-editor-usage","shape-tool",pt),N("shape")}),$(".text-editable-menu .font-size-opts input[name=fontSize]").on("input change",function(t){Analytics.trackEvent("pdf-editor-usage","text-tool","font-size");var e=$(this),a=parseInt(this.value),i=n(e),r=parseFloat(i.parents(".page-wrap").attr("data-scale"));o(e,"font-size",r*a+"px"),o(e,"line-height",r*a+"px"),o(e,"height",""),window.lastTextEditSettings.size=a}),$(".text-editable-menu .color-opts a").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","color");var t=$(this),e=t.css("background-color");o(t,"color",e),window.lastTextEditSettings.color=e}),$(document).on("click",".text-editable-menu .font-family-opts a",function(){Analytics.trackEvent("pdf-editor-usage","text-tool","font-family");var t=$(this),e=t.attr("data-font");o(t,"font-family",e),window.lastTextEditSettings.font=e}),$(".text-editable-menu .font-bold-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","bold");var t=$(this);window.lastTextEditSettings.weight=r(t,"font-weight","bold","400")}),$(".text-editable-menu .font-italic-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","italic");var t=$(this);window.lastTextEditSettings.style=r(t,"font-style","italic","normal")}),$(".text-editable-menu .delete-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","delete");var t=$(this),e=n(t);e.hasClass("existingTextEdit")?e.text(""):e.remove(),t.parents(".text-editable-menu").hide()}),$(".shape-editable-menu .border-size-opts a").click(function(){Analytics.trackEvent("pdf-editor-usage","shape-tool","border-size");var t=$(this),e=parseFloat(t.find("div").css("height").replace("px","")),a=s(t),i=parseFloat(a.parents(".page-wrap").attr("data-scale"));d(t,"border-width",Big(i).times(e).toFixed(2)+"px"),window.lastShapeEditSettings["border-width"]=e}),$(".shape-editable-menu .background-color-opts a").click(function(){Analytics.trackEvent("pdf-editor-usage","shape-tool","bg-color");var t=$(this),e=t.css("background-color");d(t,"background-color",e),window.lastShapeEditSettings["background-color"]=e}),$(".shape-editable-menu .border-color-opts a").click(function(){Analytics.trackEvent("pdf-editor-usage","shape-tool","border-color");var t=$(this),e=t.css("background-color");d(t,"border-color",e),window.lastShapeEditSettings["border-color"]=e}),$(".shape-editable-menu .delete-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","shape-tool","delete");var t=$(this);s(t).remove(),t.parents(".shape-editable-menu").hide()}),$(".image-editable-menu .delete-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","image-tool","delete");var t=$(this),e=$("#"+t.parents(".image-editable-menu").attr("data-target-id"));e.remove(),t.parents(".image-editable-menu").hide()}),$(".link-editable-menu .delete-opts").click(function(){Analytics.trackEvent("pdf-editor-usage","link-tool","delete");var t=$(this),e=$("#"+t.parents(".link-editable-menu").attr("data-target-id"));e.remove(),t.parents(".link-editable-menu").hide()}),$(".image-editable-menu .rotate-opts").click(function(t){Analytics.trackEvent("pdf-editor-usage","image-tool","rotate");var e=$(this),a=$("#"+e.parents(".image-editable-menu").attr("data-target-id")),i=parseInt(a.attr("data-rotation")||0),n=l(i,90);a.attr("data-rotation",n);try{a.resizable("destroy"),a.draggable("destroy")}catch(t){}c(a,function(){function t(){a.css("height","")}a.css({height:"",width:""}),a.resizable({aspectRatio:!0,handles:"all",autoHide:!0,stop:t}).parent(".ui-wrapper").draggable(),a.parent(".ui-wrapper").css({overflow:"",width:"",height:""}),a.parent(".ui-wrapper").on("resizestop",function(){a.parent(".ui-wrapper").css({width:"",height:""})})})});var gt=0,ht=[];$(document).on("fileUploadDone",function(t,e){"editor-image"==e.scope&&(ht.push(e),$("[data-imageupload-counter="+e.counter+"]").attr("data-file-id",e.id))}),$("#imageUploadForm").find(".image-fileupload").change(function(t){var e=t.target.files[0],a=["jpg","jpeg","gif","tiff","tif","bmp","png"];if(e.name){e.counter=gt++;var i=_.find(a,function(t){return e.name.toLowerCase().endsWith(t)});if(!i)return Analytics.trackEvent("pdf-editor-usage","image-tool","upload-failed",e.name),alert("Please select an image file. We support the following image types: "+a.join(", "))}Analytics.trackEvent("pdf-editor-usage","image-tool","upload");var n=new FileReader;n.onload=function(t){var a=$(".image-opts"),i=a.find("li:first").clone(),n=i.find("img");n.on("load",function(){a.prepend(i),i.find("img").click(),a.find("li.image-entry").slice(4).remove()}),n.attr("src",this.result).attr("data-imageupload-counter",e.counter)},n.readAsDataURL(e)});var mt=0;$(".link-editable-menu input[type=text]").on("input",function(){var t=$(this),e=$("#"+t.parents(".link-editable-menu").attr("data-target-id"));e.attr("data-uri",t.val())});var vt,wt=$("#edit-pages-wrap"),bt=$("#edit-pages");$(document).scrollStopped(h),$(window).resize(h);var $t={};document.PDFJSFonts=document.PDFJSFonts||{};var xt=debounce(function(t){var e=t.text(),a=t.css("font-family");a.indexOf("Times")>=0||a.indexOf("Helvetica")>=0||a.indexOf("Courier")>=0||S(e,a)&&L("The font is missing characters. Consider changing font family for the edited text.")},1e3),yt=!1;$(document).on("pdfPageContentRendered",function(t,e){1==e.pageNum&&($(".page-loading").hide(),$("#tools-menu").fadeIn(200))});var kt,Ct=$("#tools-menu"),St=$("#global-help-hint");St.click(function(){St.hide(),clearTimeout(kt)});var Et={text:"Click existing text to edit or click the page to add new text.",link:"Select a page area to create link.",image:"Click a location on the page to add image.",highlight:"Select text to apply highlight",strikethrough:"Select text to apply strike through",whiteout:"Select page area to whiteout",
  sign:"Click a location on the page to add signature."};$(".activate-text-tool").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","pressed"),N("text")}),Ct.find("[data-tool=text]").click(function(){Analytics.trackEvent("pdf-editor-usage","text-tool","pressed"),U()}),Ct.find("[data-tool=image]").click(function(){Analytics.trackEvent("pdf-editor-usage","image-tool","pressed"),O()}),Ct.find("[data-tool=highlight]").click(function(){Analytics.trackEvent("pdf-editor-usage","highlight-tool","pressed"),J("highlight")}),Ct.find("[data-tool=strikethrough]").click(function(){Analytics.trackEvent("pdf-editor-usage","strikethrough-tool","pressed"),J("strikethrough")}),Ct.find("[data-tool=whiteout]").click(function(){Analytics.trackEvent("pdf-editor-usage","whiteout-tool","pressed"),J("whiteout"),localStorage.getItem("whiteoutWarned")||(localStorage.setItem("whiteoutWarned","true"),setTimeout(function(){showAlert("Whiteout will hide but <strong>not completely remove</strong> the underlying text or images from the document.","warning")},2e3))}),Ct.find("[data-tool=link]").click(function(){Analytics.trackEvent("pdf-editor-usage","link-tool","pressed"),J("link")}),Ct.find("[data-tool=form]").click(function(){Analytics.trackEvent("pdf-editor-usage","form","pressed"),J("form")}),N("text",!0),rangy.init();var Tt=rangy.createHighlighter();Tt.addClassApplier(rangy.createClassApplier("highlighted",{ignoreWhiteSpace:!1,tagNames:["span"]})),Tt.addClassApplier(rangy.createClassApplier("strikethrough",{ignoreWhiteSpace:!1,tagNames:["span"]})),$(document).on("mouseup",".textLayer div",function(t){P("highlight")&&(Analytics.trackEvent("pdf-editor-usage","highlight-tool","highlighted"),window.getSelection().rangeCount&&(Tt.highlightSelection("highlighted"),W())),P("strikethrough")&&(Analytics.trackEvent("pdf-editor-usage","strikethrough-tool","strikethrough"),window.getSelection().rangeCount&&(Tt.highlightSelection("strikethrough"),$(".page-wrap").find(".strikethrough").each(function(){$(this).find(".strikethrough").each(function(){var t=$(this);t.replaceWith(t.html())})}),W()))}),$(document).on("click","[data-tool=delete-page]",function(){var t=$(this);Analytics.trackEvent("pdf-editor-usage","delete-page-tool");var e=t.parents(".page-container"),a=e.find(".page-wrap"),i=a.attr("data-original-page-num");if(i){var n=$(".task-form");n.append($('<input type="hidden" name="deletePageOperations[]">').val(JSON.stringify({page:i})))}e.fadeOut(100,function(){e.remove(),j(),h()})}),$(document).on("click",".page-between a",function(){Analytics.trackEvent("pdf-editor-usage","insert-page");var t=$(this),e=t.parents(".page-container");H(e),t.blur()}),$(window).scroll(function(){var t=$(this).scrollTop();t<220?Ct.css({position:""}).removeClass("fixed"):Ct.css({position:"fixed",top:0}).addClass("fixed")}),jQuery.fn.selectText=function(){var t,e,a=document,i=this[0];a.body.createTextRange?(t=document.body.createTextRange(),t.moveToElementText(i),t.select()):window.getSelection&&(e=window.getSelection(),t=document.createRange(),t.selectNodeContents(i),e.removeAllRanges(),e.addRange(t))},$(document).on("click","[data-tool=text] .edit-item",function(t){t.preventBubble()});var Ft=0,At=!1;jQuery.fn.inlineEditor=function(t,e,a,i,n){var o=$(this[0]);o.attr("id","text-editable-"+Ft++).addClass("text-editable").attr("contenteditable","true"),o.on("focus",function(t){V(o,r),o.draggable("disable");var e=o.text();e.trim()==window.PdfEditorSettings.defaultText&&document.execCommand("selectAll",!1,null)}),o.click(function(t){o.is('[contenteditable="false"]')&&(o.attr("contenteditable","true"),o.focus())}),o.keypress(function(t){return 13!=t.which}),o.dblclick(function(){o.selectText()}),o.blur(function(t){At=!0,setTimeout(function(){At=!1},100)}),o.on("paste",function(t){t.preventDefault();var e="";t.clipboardData||t.originalEvent.clipboardData?e=(t.originalEvent||t).clipboardData.getData("text/plain"):window.clipboardData&&(e=window.clipboardData.getData("Text"));try{document.queryCommandSupported("insertText")?document.execCommand("insertText",!1,e):document.execCommand("paste",!1,e)}catch(t){document.execCommand("paste",!1,e)}});var r=o.parents(".page-wrap"),s=parseFloat(r.attr("data-scale")),d=void 0,l=void 0;n!==!0&&(t=t||s*window.lastTextEditSettings.size+"px",e=e||window.lastTextEditSettings.font,a=a||window.lastTextEditSettings.color,d=d||window.lastTextEditSettings.weight,l=l||window.lastTextEditSettings.style),o.css({"font-size":t,"line-height":t,color:a,"font-family":e,"font-weight":d,"font-style":l}),o.draggable({containment:r}),i===!0&&(o.addClass("noDrag"),o.draggable("disable")),o.on("dragstop",function(){o.css({width:""})}),o.focus()},$(document).on("click",function(t){var e=$(t.target);if(!(X(e,"text-editable-menu")||X(e,"image-editable-menu")||X(e,"link-editable-menu")||X(e,"image-editable")||X(e,"text-editable")||X(e,"shape-editable")||X(e,"link-editable"))){if($(".text-editable").attr("contenteditable","false").each(function(){var t=$(this);t.hasClass("noDrag")||t.draggable("enable")}),$("#text-editable-menu").is(":visible"))return void $("#text-editable-menu").hide();if($("#image-editable-menu").is(":visible"))return void $("#image-editable-menu").hide();if($("#shape-editable-menu").is(":visible")){$("#shape-editable-menu").hide();var a=$("#"+$("#shape-editable-menu").attr("data-target-id"));return a.find(".ui-resizable-handle").hide(),void a.removeClass("active")}var i=$("#link-editable-menu");if(i.is(":visible")){i.hide();var n=$("#"+i.attr("data-target-id"));return n.find(".ui-resizable-handle").hide(),void n.removeClass("active")}var o=e.prop("tagName")||"";if("DIV"==o.toUpperCase()&&e.parent().hasClass("textLayer")&&!e.hasClass("not-editable")&&P("text")){Analytics.trackEvent("pdf-editor-usage","text-tool","edit");var r=e,s=r.parents(".page-wrap");v(r);var d=Y(r.css("top")),l=Y(r.css("left")),c=r.css("font-size"),f=2,u=$("<div></div>").css({position:"absolute","z-index":"10",top:d-f,left:l-f});s.append(u),u.html(r.text()).addClass("existingTextEdit"),u.attr("data-original-font-face",r.attr("data-font-face"));var p=G(r.attr("data-font-color")||"#000000");u.inlineEditor(c,r.attr("data-font-face"),p,!1,!0),r.addClass("edited").attr("data-inline-editor-id",u.attr("id"))}if((e.hasClass("page")||e.hasClass("textLayer")||e.hasClass("not-editable"))&&P("text")){if(At)return;Analytics.trackEvent("pdf-editor-usage","text-tool","inserted");var s=e.parents(".page-wrap"),u=$("<div></div>").css({position:"absolute","z-index":"10",top:t.pageY-s.offset().top-window.lastTextEditSettings.size-7+10,left:t.pageX-s.offset().left-7});s.append(u),u.html(window.PdfEditorSettings.defaultText).inlineEditor()}}}),$(document).on("blur",".text-editable",function(t){var e=$(this),a=e.text();e.text(cleanUnicodeControlCharsAndSpaces(a))}),$(document).on("keyup",".text-editable",function(t){var e=$(this);xt(e)}),$(document).on("filesSelected",function(t,e){D(e.files[0])}),$(document).bind("keydown",function(t){var e=!1;if(8===t.keyCode){var a=t.srcElement||t.target,i=$(a);e=("INPUT"!==a.tagName.toUpperCase()||"TEXT"!==a.type.toUpperCase()&&"PASSWORD"!==a.type.toUpperCase()&&"FILE"!==a.type.toUpperCase()&&"SEARCH"!==a.type.toUpperCase()&&"EMAIL"!==a.type.toUpperCase()&&"NUMBER"!==a.type.toUpperCase()&&"DATE"!==a.type.toUpperCase())&&!i.is('[contenteditable="true"]')&&"TEXTAREA"!==a.tagName.toUpperCase()||(a.readOnly||a.disabled)}e&&t.preventDefault()}),$("#save-pdf-btn").click(function(t){t.preventDefault();var e=[],a=$("#edit-pages");a.find(".text-editable").each(function(){var t=$(this);t.text()==window.PdfEditorSettings.defaultText&&e.push(t)}),e.length>0?Z(function(t){"yes"==t&&e.forEach(function(t){t.remove()}),at(et())}):at(et())}),$(document).on("input",".formLayer input",function(t){$(this).attr("data-changed","true")}),$(document).on("click",".formLayer input[type=radio]",function(t){var e=$(this);if("radio"==e.attr("type")&&""==e.val())return alert("There's something wrong with this form field. We cannot update its value."),t.preventDefault(),!1}),$(document).on("click",".formLayer input[type=checkbox], .formLayer input[type=radio]",function(t){var e=$(this);e.attr("data-changed","true");var a=this.checked,i=e.attr("data-field-id");$('input[type=checkbox][data-field-id="'+i+'"]').not(e).prop("checked",!1).attr("data-changed","true"),this.checked=a}),$(document).on("change",".formLayer select, .formLayer textarea",function(t){$(this).attr("data-changed","true")});var zt=Date.now(),Bt=["appendTextOperations","editTextOperations","imageOperations","shapeOperations","insertPageOperations","highlightTextOperations","strikethroughTextOperations","linkOperations","formValues"];(function(){function t(t){try{var e=!0;if(Bt.forEach(function(a){t[a].length>0&&(e=!1)}),e)return;t.recovery={filename:d.name,fileSize:d.size,timestamp:Date.now()},c.setItem("recovery-"+l,JSON.stringify(t))}catch(t){console.error("Failed to save recovery data",t)}}function e(){c.removeItem("recovery-"+l)}function a(t){for(var e=0;e<c.length;e++){var a=c.key(e);if(a&&0==a.indexOf("recovery-"))try{var i=JSON.parse(c.getItem(a));t(i,a)}catch(t){console.error("Failed to prune recovery data",t)}}}function i(t,e){a(function(a,i){a.recovery.filename==t.name&&a.recovery.fileSize==t.size&&e(a,i)})}function n(t){var e=[];return i(t,function(t){e.push(t)}),e}function o(t){i(t,function(t,e){c.removeItem(e)})}function r(){var t=Date.now()-1728e5;a(function(e,a){e.recovery.timestamp<t&&c.removeItem(a)})}function s(){setInterval(function(){f&&t(et())},5e3)}if(!window.EditorRecoveryDisabled){var d,l=Date.now(),c=localStorage,f=!1;$(document).on("fileUploadStarted",function(t,e){if("task-file"==e.scope)try{d=e;var a=n(e);if(a.length>0){var i=$("#recoveryPrompt"),l=i.find(".recovery-sessions");a.forEach(function(t){var e=new Date(t.recovery.timestamp),a=e.getHours()+":"+("0"+e.getMinutes()).slice(-2),i=$('<a href="javascript://"></a>').text("Restore edits from session around "+a).click(function(){at(t)});l.append($("<li></li>").append(i))}),i.find(".btn-no").off("click").on("click",function(){i.modal("hide"),o(e)}),i.modal("show")}s(),r()}catch(t){console.error("Failed to process recovery data",t)}}),$(document).on("taskSubmitDone",function(){f=!1,e()}),$(document).on("click",".page-wrap",function(){f=!0})}})();$(function(){$("#add-signature-link").click(function(){$("#createSignatureModal").modal("show")})});var It=$(".signaturePreview"),Dt=$("#signatureName");Dt.change(function(){window.localStorage.setItem("signatureName",$(this).val())});var Ot=document.getElementById("signaturePadCanvas"),Pt=new SignaturePad(Ot,{minWidth:2});$("#signaturePadClearBtn").click(function(){Pt.clear()});var Rt=$("#createSignatureModal");Rt.on("shown.bs.modal",function(){Analytics.trackEvent("pdf-editor-usage","signature-tool","opened"),Dt[0].setSelectionRange(0,9999),Dt.focus(),it()}),Rt.find(".btn-ok").click(function(){var t=Rt.find(".tab-pane.active").attr("id");if(console.log("Active tab",t),"signature-typed"==t){var e=It.first().css("font-family");nt(e)}else"signature-drawn"==t&&st()}),Dt.on("keyup",it),Rt.find(".nav-tabs li a[data-target]").click(function(t){t.preventDefault(),$(this).tab("show")}),$("#signature-image-link").find(".image-fileupload").change(function(t){var e=t.target.files[0],a=["jpg","jpeg","gif","tiff","tif","bmp","png"];if(e.name){e.counter=gt++;var i=_.find(a,function(t){return e.name.toLowerCase().endsWith(t)});if(!i)return alert("Please select an image file. We support the following image types: "+a.join(", "))}var n=new FileReader;n.onload=function(t){var a=$('<li><a href="javascript://"><img src=""></a></li>'),i=a.find("img");$("ul.sign-opts").prepend(a),$("ul.sign-opts").find("li.default").remove(),i.on("load",function(){Rt.modal("hide"),setTimeout(function(){i.click()},100),Analytics.trackEvent("pdf-editor-usage","sign-tool","from-image")}),i.attr("src",this.result).attr("data-imageupload-counter",e.counter)},n.readAsDataURL(e)}),It.click(function(){var t=$(this),e=t.css("font-family");nt(e)});var Lt=["Stalemate","Over the Rainbow","Caveat","Cedarville Cursive","Dancing Script","Give You Glory","Kristi","Mr De Haviland","Norican","Reenie Beanie","Satisfy","Zeyada"];dt(Lt,function(){var t=window.localStorage.getItem("signatureName"),e=window.localStorage.getItem("signatureFont");t&&e&&(Dt.val(t),rt(e))}),Tippy(".edit-menu button",{arrow:!0,animation:"fade",delay:[300,0]})});